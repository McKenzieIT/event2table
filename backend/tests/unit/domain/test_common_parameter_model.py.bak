"""
Unit Tests for CommonParameter Domain Model

Tests for the CommonParameter value object including:
- Creation and validation
- Threshold calculation
- Common criteria checking
- Serialization/Deserialization
"""

import pytest
from datetime import datetime
from backend.domain.models.common_parameter import (
    CommonParameter,
    CommonParameterCalculationResult
)
from backend.domain.models.parameter import ParameterType


class TestCommonParameterCreation:
    """Test common parameter creation and validation"""

    def test_common_parameter_creation_valid(self):
        """Test valid common parameter creation"""
        param = CommonParameter(
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_name_cn='公会ID',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5,
            threshold=0.8
        )

        assert param.id == 1
        assert param.game_gid == 90000001
        assert param.param_name == 'guild_id'
        assert param.param_name_cn == '公会ID'
        assert param.param_type == ParameterType.STRING
        assert param.occurrence_count == 4
        assert param.total_events == 5
        assert param.threshold == 0.8

    def test_common_parameter_validation_empty_name(self):
        """Test validation fails with empty name"""
        with pytest.raises(ValueError, match="参数名称不能为空"):
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='',
                param_type=ParameterType.STRING,
                occurrence_count=4,
                total_events=5
            )

    def test_common_parameter_validation_negative_occurrence(self):
        """Test validation fails with negative occurrence"""
        with pytest.raises(ValueError, match="出现次数不能为负数"):
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='test',
                param_type=ParameterType.STRING,
                occurrence_count=-1,
                total_events=5
            )

    def test_common_parameter_validation_negative_total_events(self):
        """Test validation fails with negative total events"""
        with pytest.raises(ValueError, match="总事件数不能为负数"):
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='test',
                param_type=ParameterType.STRING,
                occurrence_count=4,
                total_events=-1
            )

    def test_common_parameter_validation_occurrence_exceeds_total(self):
        """Test validation fails when occurrence exceeds total"""
        with pytest.raises(ValueError, match="出现次数不能大于总事件数"):
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='test',
                param_type=ParameterType.STRING,
                occurrence_count=6,
                total_events=5
            )

    def test_common_parameter_validation_invalid_threshold_low(self):
        """Test validation fails with threshold <= 0"""
        with pytest.raises(ValueError, match="阈值必须在0和1之间"):
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='test',
                param_type=ParameterType.STRING,
                occurrence_count=4,
                total_events=5,
                threshold=0
            )

    def test_common_parameter_validation_invalid_threshold_high(self):
        """Test validation fails with threshold > 1"""
        with pytest.raises(ValueError, match="阈值必须在0和1之间"):
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='test',
                param_type=ParameterType.STRING,
                occurrence_count=4,
                total_events=5,
                threshold=1.5
            )

    def test_common_parameter_default_values(self):
        """Test common parameter with default values"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='test',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5
        )

        # Default threshold
        assert param.threshold == 0.8
        # Default calculated_at is datetime
        assert isinstance(param.calculated_at, datetime)


class TestCommonParameterThresholdCalculation:
    """Test threshold calculation logic"""

    def test_is_above_threshold_true_exact(self):
        """Test is_above_threshold returns True at exact threshold"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5,
            threshold=0.8
        )

        assert param.is_above_threshold() is True

    def test_is_above_threshold_true_above(self):
        """Test is_above_threshold returns True above threshold"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_type=ParameterType.STRING,
            occurrence_count=5,
            total_events=5,
            threshold=0.8
        )

        assert param.is_above_threshold() is True

    def test_is_above_threshold_false_below(self):
        """Test is_above_threshold returns False below threshold"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='role_id',
            param_type=ParameterType.INT,
            occurrence_count=3,
            total_events=5,
            threshold=0.8
        )

        assert param.is_above_threshold() is False

    def test_is_above_threshold_zero_total_events(self):
        """Test is_above_threshold returns False with zero total events"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='test',
            param_type=ParameterType.STRING,
            occurrence_count=0,
            total_events=0,
            threshold=0.8
        )

        assert param.is_above_threshold() is False

    def test_get_occurrence_ratio(self):
        """Test get_occurrence_ratio calculation"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5,
            threshold=0.8
        )

        ratio = param.get_occurrence_ratio()
        assert ratio == 0.8

    def test_get_occurrence_ratio_zero_total_events(self):
        """Test get_occurrence_ratio returns 0 with zero total events"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='test',
            param_type=ParameterType.STRING,
            occurrence_count=0,
            total_events=0,
            threshold=0.8
        )

        ratio = param.get_occurrence_ratio()
        assert ratio == 0.0


class TestCommonParameterCriteria:
    """Test common parameter criteria checking"""

    def test_meets_common_criteria_true_both_rules(self):
        """Test meets_common_criteria returns True when both rules met"""
        # 5/5 events = 100%, >= 2 events
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='zone_id',
            param_type=ParameterType.INT,
            occurrence_count=5,
            total_events=5,
            threshold=0.8
        )

        assert param.meets_common_criteria() is True

    def test_meets_common_criteria_true_80_percent_2_events(self):
        """Test meets_common_criteria returns True at 80% with 2 events"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5,
            threshold=0.8
        )

        assert param.meets_common_criteria() is True

    def test_meets_common_criteria_fails_below_threshold(self):
        """Test meets_common_criteria returns False below 80%"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='role_id',
            param_type=ParameterType.INT,
            occurrence_count=3,
            total_events=5,
            threshold=0.8
        )

        # 3/5 = 60% < 80%
        assert param.meets_common_criteria() is False

    def test_meets_common_criteria_fails_less_than_2_events(self):
        """Test meets_common_criteria returns False with < 2 events"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='level',
            param_type=ParameterType.INT,
            occurrence_count=1,
            total_events=5,
            threshold=0.8
        )

        # 1/5 = 20% < 2 events minimum
        assert param.meets_common_criteria() is False

    def test_meets_common_criteria_zero_total_events(self):
        """Test meets_common_criteria returns False with zero total events"""
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='test',
            param_type=ParameterType.STRING,
            occurrence_count=0,
            total_events=0,
            threshold=0.8
        )

        assert param.meets_common_criteria() is False

    def test_meets_common_criteria_custom_threshold(self):
        """Test meets_common_criteria with custom threshold"""
        # 3/10 = 30% < 70% threshold
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='test',
            param_type=ParameterType.STRING,
            occurrence_count=3,
            total_events=10,
            threshold=0.7
        )

        assert param.meets_common_criteria() is False


class TestCommonParameterSerialization:
    """Test common parameter serialization and deserialization"""

    def test_to_dict(self):
        """Test common parameter to dictionary conversion"""
        now = datetime.now()
        param = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_name_cn='公会ID',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5,
            threshold=0.8,
            calculated_at=now
        )

        result = param.to_dict()

        assert result['id'] == 1
        assert result['game_gid'] == 90000001
        assert result['param_name'] == 'guild_id'
        assert result['param_name_cn'] == '公会ID'
        assert result['param_type'] == 'string'
        assert result['occurrence_count'] == 4
        assert result['total_events'] == 5
        assert result['threshold'] == 0.8
        assert result['occurrence_ratio'] == 0.8
        assert result['meets_criteria'] is True
        assert result['calculated_at'] == now.isoformat()

    def test_from_dict(self):
        """Test common parameter creation from dictionary"""
        now = datetime.now()
        data = {
            'id': 1,
            'game_gid': 90000001,
            'param_name': 'guild_id',
            'param_name_cn': '公会ID',
            'param_type': 'string',
            'occurrence_count': 4,
            'total_events': 5,
            'threshold': 0.8,
            'calculated_at': now.isoformat()
        }

        param = CommonParameter.from_dict(data)

        assert param.id == 1
        assert param.game_gid == 90000001
        assert param.param_name == 'guild_id'
        assert param.param_name_cn == '公会ID'
        assert param.param_type == ParameterType.STRING
        assert param.occurrence_count == 4
        assert param.total_events == 5
        assert param.threshold == 0.8

    def test_from_dict_with_param_type_string(self):
        """Test from_dict converts string to ParameterType"""
        data = {
            'game_gid': 90000001,
            'param_name': 'guild_id',
            'param_type': 'int',  # String
            'occurrence_count': 4,
            'total_events': 5
        }

        param = CommonParameter.from_dict(data)

        assert isinstance(param.param_type, ParameterType)
        assert param.param_type == ParameterType.INT

    def test_serialization_roundtrip(self):
        """Test serialization and deserialization roundtrip"""
        original = CommonParameter(
                param_name_cn=None,
            id=1,
            game_gid=90000001,
            param_name='guild_id',
            param_name_cn='公会ID',
            param_type=ParameterType.STRING,
            occurrence_count=4,
            total_events=5,
            threshold=0.8
        )

        # Serialize
        data = original.to_dict()

        # Deserialize
        restored = CommonParameter.from_dict(data)

        # Verify
        assert restored.id == original.id
        assert restored.game_gid == original.game_gid
        assert restored.param_name == original.param_name
        assert restored.param_name_cn == original.param_name_cn
        assert restored.param_type == original.param_type
        assert restored.occurrence_count == original.occurrence_count
        assert restored.total_events == original.total_events
        assert restored.threshold == original.threshold


class TestCommonParameterCalculationResult:
    """Test CommonParameterCalculationResult value object"""

    def test_calculation_result_creation(self):
        """Test calculation result creation"""
        now = datetime.now()
        common_params = [
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='guild_id',
                param_type=ParameterType.STRING,
                occurrence_count=4,
                total_events=5
            )
        ]

        result = CommonParameterCalculationResult(
            game_gid=90000001,
            total_events=5,
            total_parameters=10,
            common_parameters=common_params,
            calculation_time=now,
            threshold_used=0.8
        )

        assert result.game_gid == 90000001
        assert result.total_events == 5
        assert result.total_parameters == 10
        assert len(result.common_parameters) == 1
        assert result.calculation_time == now
        assert result.threshold_used == 0.8

    def test_get_summary(self):
        """Test get_summary method"""
        now = datetime.now()
        common_params = [
            CommonParameter(
                param_name_cn=None,
                id=1,
                game_gid=90000001,
                param_name='guild_id',
                param_type=ParameterType.STRING,
                occurrence_count=4,
                total_events=5
            ),
            CommonParameter(
                param_name_cn=None,
                id=2,
                game_gid=90000001,
                param_name='zone_id',
                param_type=ParameterType.INT,
                occurrence_count=5,
                total_events=5
            )
        ]

        result = CommonParameterCalculationResult(
            game_gid=90000001,
            total_events=5,
            total_parameters=10,
            common_parameters=common_params,
            calculation_time=now,
            threshold_used=0.8
        )

        summary = result.get_summary()

        assert summary['game_gid'] == 90000001
        assert summary['total_events'] == 5
        assert summary['total_parameters'] == 10
        assert summary['common_parameters_count'] == 2
        assert summary['threshold_used'] == 0.8
        assert summary['calculation_time'] == now.isoformat()
        assert summary['common_parameter_names'] == ['guild_id', 'zone_id']

    def test_get_summary_empty_common_parameters(self):
        """Test get_summary with no common parameters"""
        now = datetime.now()
        result = CommonParameterCalculationResult(
            game_gid=90000001,
            total_events=5,
            total_parameters=10,
            common_parameters=[],
            calculation_time=now,
            threshold_used=0.8
        )

        summary = result.get_summary()

        assert summary['common_parameters_count'] == 0
        assert summary['common_parameter_names'] == []
