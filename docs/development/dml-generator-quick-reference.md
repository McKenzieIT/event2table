# DML Generator å¿«é€Ÿå‚è€ƒ

> **ç‰ˆæœ¬**: 1.0 | **æœ€åæ›´æ–°**: 2026-02-17

---

## ğŸš€ å¿«é€Ÿå¼€å§‹

### å¯¼å…¥

```python
from backend.services.hql.core.dml_generator import (
    DMLGenerator,
    DMLBuilderFactory,
    generate_insert_overwrite
)
```

---

## ğŸ“– å¸¸è§ç”¨æ³•

### 1. åŸºæœ¬INSERT OVERWRITE

```python
generator = DMLGenerator()

dml = generator.generate_insert_overwrite(
    target_table="dwd.v_dwd_10000147_login_di",
    source_query="SELECT role_id, account_id FROM ods_table",
    partition_ds="20260217"
)
```

### 2. åŠ¨æ€åˆ†åŒºå˜é‡

```python
dml = generator.generate_insert_overwrite(
    target_table="dwd.v_dwd_10000147_login_di",
    source_query="SELECT * FROM ods_table",
    partition_ds="${bizdate}"  # æˆ– "${ds}"
)
```

### 3. å·¥å‚æ¨¡å¼ï¼ˆæ¨èï¼‰

```python
# è‡ªåŠ¨ç”Ÿæˆæ ‡å‡†è¡¨å
dml = DMLBuilderFactory.create_etl_dml(
    dwd_prefix="dwd",
    game_gid=10000147,
    event_name="login",
    source_query="SELECT * FROM ods_table",
    partition_ds="20260217"
)
# ç”Ÿæˆ: dwd.v_dwd_10000147_login_di
```

### 4. æ‰¹é‡æ’å…¥ï¼ˆUNION ALLï¼‰

```python
queries = [
    "SELECT * FROM ods_login",
    "SELECT * FROM ods_logout"
]

dml = DMLBuilderFactory.create_batch_insert(
    target_table="dwd.all_events_di",
    source_queries=queries,
    partition_ds="20260217"
)
```

### 5. å¯¼å‡ºåˆ°æ–‡ä»¶ç³»ç»Ÿ

```python
dml = generator.generate_insert_overwrite_directory(
    target_directory="hdfs:///data/export/20260217",
    source_query="SELECT * FROM dwd_table",
    file_format="PARQUET"
)
```

---

## ğŸ¯ ä¸HQL Generatoré…åˆ

### å®Œæ•´ETLæµç¨‹

```python
from backend.services.hql.core.generator import HQLGenerator
from backend.services.hql.core.dml_generator import DMLGenerator
from backend.services.hql.models.event import Event, Field, FieldType

# 1. ç”ŸæˆSELECTæŸ¥è¯¢
hql_gen = HQLGenerator()

event = Event(name="login", table_name="ieu_ods.ods_10000147_all_view")
fields = [
    Field(name="role_id", type=FieldType.BASE),
    Field(name="zone_id", type=FieldType.PARAM, json_path="$.zoneId"),
]

select_query = hql_gen.generate(events=[event], fields=fields, conditions=[])

# 2. ç”ŸæˆINSERT OVERWRITE
dml_gen = DMLGenerator()

dml = dml_gen.generate_insert_overwrite(
    target_table="dwd.v_dwd_10000147_login_di",
    source_query=select_query,
    partition_ds="${bizdate}"
)

print(dml)
```

---

## âš™ï¸ å‚æ•°è¯´æ˜

### generate_insert_overwrite()

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `target_table` | str | âœ… | ç›®æ ‡è¡¨åï¼ˆdatabase.tableï¼‰ | `"dwd.v_dwd_10000147_login_di"` |
| `source_query` | str | âœ… | æºSELECTæŸ¥è¯¢ | `"SELECT role_id FROM ods_table"` |
| `partition_ds` | str | âœ… | åˆ†åŒºæ—¥æœŸï¼ˆYYYYMMDDæˆ–å˜é‡ï¼‰ | `"20260217"` æˆ– `"${bizdate}"` |
| `include_comments` | bool | âŒ | æ˜¯å¦åŒ…å«æ³¨é‡Šï¼ˆé»˜è®¤Trueï¼‰ | `True` æˆ– `False` |

### generate_insert_overwrite_directory()

| å‚æ•° | ç±»å‹ | å¿…å¡« | è¯´æ˜ | ç¤ºä¾‹ |
|------|------|------|------|------|
| `target_directory` | str | âœ… | ç›®æ ‡ç›®å½•è·¯å¾„ | `"hdfs:///data/export/20260217"` |
| `source_query` | str | âœ… | æºSELECTæŸ¥è¯¢ | `"SELECT * FROM dwd_table"` |
| `file_format` | str | âŒ | æ–‡ä»¶æ ¼å¼ï¼ˆé»˜è®¤TEXTFILEï¼‰ | `"PARQUET"`, `"ORC"` |
| `field_delim` | str | âŒ | å­—æ®µåˆ†éš”ç¬¦ï¼ˆé»˜è®¤\\tï¼‰ | `","` |
| `line_delim` | str | âŒ | è¡Œåˆ†éš”ç¬¦ï¼ˆé»˜è®¤\\nï¼‰ | `"\\n"` |

---

## ğŸ›¡ï¸ å®‰å…¨ç‰¹æ€§

### è‡ªåŠ¨éªŒè¯

- âœ… è¡¨åæ ¼å¼éªŒè¯ï¼ˆå¿…é¡»æ˜¯ `database.table`ï¼‰
- âœ… SQLæ³¨å…¥é˜²æŠ¤ï¼ˆæ£€æµ‹å±é™©å…³é”®å­—ï¼‰
- âœ… æºæŸ¥è¯¢éªŒè¯ï¼ˆä»…å…è®¸SELECTè¯­å¥ï¼‰
- âœ… åˆ†åŒºæ—¥æœŸæ ¼å¼éªŒè¯ï¼ˆYYYYMMDDæˆ–å˜é‡ï¼‰

### é”™è¯¯ç¤ºä¾‹

```python
# âŒ é”™è¯¯ï¼šè¡¨åæ ¼å¼ä¸æ­£ç¡®
generator.generate_insert_overwrite(
    target_table="table_name",  # ç¼ºå°‘databaseå‰ç¼€
    source_query="SELECT * FROM table",
    partition_ds="20260217"
)
# ValueError: target_table must be in format 'database.table'

# âŒ é”™è¯¯ï¼šæºæŸ¥è¯¢åŒ…å«å±é™©æ“ä½œ
generator.generate_insert_overwrite(
    target_table="dwd.table",
    source_query="DROP TABLE other; SELECT * FROM table",
    partition_ds="20260217"
)
# ValueError: Dangerous operation 'DROP TABLE' found in source_query

# âŒ é”™è¯¯ï¼šæ— æ•ˆçš„æ—¥æœŸæ ¼å¼
generator.generate_insert_overwrite(
    target_table="dwd.table",
    source_query="SELECT * FROM table",
    partition_ds="2026-02-17"  # é”™è¯¯æ ¼å¼ï¼Œåº”ä¸ºYYYYMMDD
)
# ValueError: partition_ds must be in format YYYYMMDD
```

---

## ğŸ“‹ è¾“å‡ºæ ¼å¼

### INSERT OVERWRITE TABLEï¼ˆå¸¦æ³¨é‡Šï¼‰

```sql
-- Generated by Event2Table DML Generator
-- Timestamp: 2026-02-17 17:36:47
-- Target Table: dwd.v_dwd_10000147_login_di
-- Partition: ds='20260217'
-- Description: INSERT OVERWRITE for partition loading
INSERT OVERWRITE TABLE dwd.v_dwd_10000147_login_di
PARTITION (ds='20260217')
SELECT role_id, account_id FROM ods_table
```

### INSERT OVERWRITE TABLEï¼ˆæ— æ³¨é‡Šï¼‰

```sql
INSERT OVERWRITE TABLE dwd.v_dwd_10000147_login_di
PARTITION (ds='20260217')
SELECT role_id, account_id FROM ods_table
```

### INSERT OVERWRITE DIRECTORY

```sql
-- Export to directory: hdfs:///data/export/20260217
INSERT OVERWRITE DIRECTORY 'hdfs:///data/export/20260217'
ROW FORMAT DELIMITED
FIELDS TERMINATED BY ','
LINES TERMINATED BY '\n'
STORED AS PARQUET
SELECT * FROM dwd_table
```

---

## ğŸ’¡ æœ€ä½³å®è·µ

### 1. ä½¿ç”¨å·¥å‚æ¨¡å¼

```python
# âœ… æ¨èï¼šä½¿ç”¨å·¥å‚æ¨¡å¼
dml = DMLBuilderFactory.create_etl_dml(
    dwd_prefix="dwd",
    game_gid=10000147,
    event_name="login",
    source_query=select_query,
    partition_ds="${bizdate}"
)

# âŒ ä¸æ¨èï¼šæ‰‹åŠ¨æ‹¼æ¥è¡¨å
target_table = f"dwd.v_dwd_{game_gid}_{event_name}_di"
dml = generator.generate_insert_overwrite(
    target_table=target_table,
    source_query=select_query,
    partition_ds="${bizdate}"
)
```

### 2. åŠ¨æ€åˆ†åŒºå˜é‡

```python
# âœ… æ¨èï¼šä½¿ç”¨Hiveå˜é‡
partition_ds="${bizdate}"

# âŒ ä¸æ¨èï¼šç¡¬ç¼–ç æ—¥æœŸ
partition_ds="20260217"
```

### 3. å¤šè¡ŒæŸ¥è¯¢æ ¼å¼åŒ–

```python
# âœ… æ¨èï¼šæ ¼å¼åŒ–çš„å¤šè¡ŒæŸ¥è¯¢
source_query = """SELECT
  role_id,
  account_id,
  get_json_object(params, '$.zoneId') AS zone_id
FROM ods_table
WHERE ds = '${bizdate}'"""

# DMLç”Ÿæˆå™¨ä¼šè‡ªåŠ¨å‹ç¼©å¤šä½™çš„ç©ºç™½è¡Œ
```

---

## ğŸ”— ç›¸å…³æ–‡æ¡£

- [DML Generatorå®ç°æ€»ç»“](../../reports/2026-02-17/dml-generator-implementation-summary.md)
- [HQL V2æ¶æ„æ–‡æ¡£](../../development/hql-v2-architecture.md)
- [ä½¿ç”¨ç¤ºä¾‹é›†](../../../backend/services/hql/examples/dml_usage_examples.py)

---

## ğŸ§ª æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰DMLæµ‹è¯•
python3 -m pytest backend/test/unit/services/hql/test_dml*.py -v

# è¿è¡Œå•å…ƒæµ‹è¯•
python3 -m pytest backend/test/unit/services/hql/test_dml_generator.py -v

# è¿è¡Œé›†æˆæµ‹è¯•
python3 -m pytest backend/test/unit/services/hql/test_dml_integration.py -v
```

---

**æ–‡æ¡£ç‰ˆæœ¬**: 1.0
**æœ€åæ›´æ–°**: 2026-02-17
**ç»´æŠ¤è€…**: Event2Table Development Team
