# 产品需求文档 (PRD)

> **Event2Table** - DWD层HQL自动生成工具
>
> **版本**: 1.2.0 | **最后更新**: 2026-02-18

---

## 1. 产品概述

### 1.1 产品定位

Event2Table 是一个数据仓库（DWD）层HQL自动生成工具，帮助数据工程师从手动编写Hive SQL转变为可视化配置模式，大幅提升数据仓库视图的开发效率。

**核心能力**：
- **基础模块**：ETL数据抽取，支持CREATE TABLE + INSERT OVERWRITE
- **高级模块**：Canvas可视化系统 + 事件节点定制
- **HQL生成**：Single/Join/Union三种模式，自动生成标准Hive视图

### 1.2 核心价值

| 价值 | 描述 |
|------|------|
| **提升效率** | 从手动编写HQL到可视化配置，效率提升10倍以上 |
| **降低门槛** | 通过Canvas界面，让非SQL专家也能构建复杂HQL查询 |
| **标准化管理** | 统一事件定义、参数规范、HQL模板，减少人工错误 |
| **快速迭代** | 支持实时预览和快速调试，缩短开发-测试周期 |

### 1.3 目标用户

- **数据工程师**：配置游戏事件、生成HQL视图、管理数据仓库
- **数据分析师**：理解数据模型、使用Canvas构建查询、验证数据正确性
- **数据仓库管理员**：管理游戏项目、监控数据质量、维护参数规范

---

## 2. 功能需求

### 2.1 核心功能模块

#### 2.1.1 游戏管理

**功能描述**：管理游戏项目的元数据和配置，作为数据处理的业务单元。

**核心能力**：
- **游戏创建**：配置GID（如10000147）、游戏名称、ODS数据源（ieu_ods/hdyl_data_sg）
- **游戏列表**：查看所有游戏，显示事件数量、参数数量等统计信息
- **游戏编辑**：修改游戏配置信息（名称、数据源）
- **游戏删除**：支持批量删除游戏，自动级联删除关联事件和参数
- **游戏上下文**：全局游戏选择，影响所有模块（事件/参数/HQL生成）的数据范围

**技术实现**：
- API层：`POST /api/games`、`GET /api/games`、`DELETE /api/games/<gid>`
- 数据验证：Pydantic Schema验证GID格式和数据源类型
- 缓存优化：L1缓存（60秒）+ L2缓存（300秒）

#### 2.1.2 事件管理

**功能描述**：定义和管理游戏事件，是HQL生成的核心数据源。

**核心能力**：
- **事件创建**：配置事件英文名、中文名、类别（login/purchase/level_up等）
- **事件列表**：按游戏筛选事件，查看事件详情、字段列表
- **事件编辑**：修改事件定义（名称、类别、是否包含通用参数）
- **事件删除**：删除事件及其参数定义
- **Excel导入**：从Excel批量导入事件定义，自动识别列名和类型

**技术实现**：
- 表名自动生成：`{ods_db}.ods_{game_gid}_{event_name}_view`
- API契约：前端调用必须与后端路由一致（HTTP方法、参数格式）
- 批量操作：支持批量创建/编辑/删除事件

#### 2.1.3 事件分类管理 ⭐

**功能描述**：事件分类管理功能，用于组织和归类游戏事件，支持多对多关系。

**核心能力**：
- **创建分类**：定义事件分类（如login、purchase、level_up等），便于事件组织
- **分类列表**：按游戏筛选分类，显示每个分类下的事件数量（包括0事件的分类）
- **编辑分类**：修改分类名称和描述
- **删除分类**：删除分类及其与事件的关联关系（不影响事件本身）
- **批量操作**：
  - 批量删除：一次删除多个分类
  - 批量更新：统一更新多个分类的属性
- **事件关联**：一个事件可属于多个分类，支持灵活的归类方式

**技术实现**：
- API端点：
  - `GET /api/categories?game_gid=<gid>` - 获取分类列表（含事件计数）
  - `POST /api/categories` - 创建新分类
  - `PUT /api/categories/<id>` - 更新分类
  - `DELETE /api/categories/<id>` - 删除单个分类
  - `DELETE /api/categories/batch` - 批量删除分类
  - `PUT /api/categories/batch-update` - 批量更新分类
- 数据验证：Pydantic Schema验证分类名称（唯一性、长度限制）
- 缓存管理：分类数据变更时自动清理相关缓存
- 数据模型：
  - `event_categories` 表：分类主表（id, name, created_at, updated_at）
  - `event_category_relations` 表：事件-分类关联表（多对多关系）

#### 2.1.4 事件节点构建器 ⭐

**功能描述**：可视化配置单个事件的HQL生成规则，支持实时预览和调试。

**核心能力**：

**字段构建器**：
- **基础字段**：ds, role_id, account_id, utdid, envinfo, tm, ts
- **参数字段**：使用`get_json_object(params, '$.fieldName')`提取JSON字段
- **计算字段**：支持SQL表达式和别名

**WHERE条件构建器**：
- **分区过滤**：默认条件`ds = '${bizdate}'`
- **自定义条件**：支持简单条件（field = value）和范围条件（BETWEEN）
- **复合条件**：支持AND/OR逻辑组合

**JOIN条件构建器**：
- **多事件关联**：配置两个或多个事件的JOIN条件
- **关联类型**：INNER JOIN、LEFT JOIN、RIGHT JOIN、FULL OUTER JOIN
- **ON条件**：基于字段匹配（t0.role_id = t1.role_id）

**实时预览**：
- 即时生成HQL语句
- 语法高亮和格式化
- 一键复制或下载HQL文件

**模式切换**：
- **Single模式**：单事件HQL生成
- **Join模式**：多事件JOIN关联
- **Union模式**：多事件UNION合并

**DDL/DML生成器**：
- **DDL Generator**：自动生成CREATE TABLE和ALTER TABLE语句
  - 智能类型推断：根据字段定义自动推断Hive数据类型
  - 表结构管理：支持添加/修改/删除列
  - 分区定义：自动生成分区字段（ds）
- **DML Generator**：自动生成INSERT OVERWRITE语句
  - 数据验证：参数验证和SQL注入防护
  - 批量插入：支持批量数据插入优化
  - 事务支持：保证数据一致性

**技术实现**：
- Builder模式：FieldBuilder、WhereBuilder、JoinBuilder、UnionBuilder
- DDL/DML生成器：DDLGenerator、DMLGenerator
- 前端组件：EventNodeBuilder（React组件）
- API端点：`POST /api/hql/generate`
- 测试覆盖：59个单元测试（DDL 29个 + DML 30个），100%通过率

#### 2.1.5 参数管理系统

**功能描述**：管理事件参数字段定义，支持跨事件参数分析和质量评估。

**核心能力**：
- **参数定义**：配置参数名、JSON路径（$.zoneId）、数据类型（string/int/float/boolean/array）
- **参数列表**：查看所有参数，按类型筛选、搜索参数名
- **跨事件参数**：识别和提取跨事件通用参数（如role_id, account_id, utdid）
- **参数分析**：
  - 参数使用统计：哪些事件使用了该参数
  - 参数质量评估：覆盖率、空值率
  - 参数网络可视化：参数之间的关系图

**技术实现**：
- JSON路径解析：使用`get_json_object(params, '$.path')`
- 类型推断：自动推断字段类型（基于事件数据样本）
- 参数库：存储可复用的参数定义模板

#### 2.1.6 Canvas可视化查询构建器 ⭐

**功能描述**：拖拽式可视化构建复杂HQL查询流程，支持流程保存和复用。

**核心能力**：

**节点类型**：
- **Table节点**：数据源节点，配置表名和游戏GID
- **Join节点**：关联节点，配置JOIN类型和条件
- **Union节点**：合并节点，配置UNION类型（ALL/DISTINCT）
- **Filter节点**：过滤节点，配置WHERE条件
- **Output节点**：输出节点，定义最终HQL视图名称

**拖拽连线**：
- ReactFlow可视化界面
- 节点拖拽定位
- 连线定义数据流向
- 节点属性面板（右侧边栏）

**流程保存**：
- 保存Canvas模板到数据库
- 快速加载已保存的流程
- 模板命名和描述

**HQL生成**：
- 从Canvas流程自动生成HQL
- 支持复杂嵌套查询
- 执行计划优化（连接顺序、过滤下推）

**Mock预览**：
- 测试查询结果预览
- 显示前N行数据
- 验证查询逻辑正确性

**技术实现**：
- 前端：ReactFlow + TypeScript
- 后端：CanvasService解析节点图
- API端点：`POST /api/canvas/templates`、`POST /api/canvas/generate`

#### 2.1.7 HQL历史管理V2 ⭐

**功能描述**：管理和查询历史生成的HQL语句，支持快速检索和复用。

**核心能力**：
- **模糊搜索**：支持按HQL内容、事件名称、游戏GID进行模糊搜索
- **多类型支持**：区分不同类型的HQL（Single/Join/Union/DDL/DML）
- **全局查询**：跨游戏查询所有历史HQL记录
- **快速复用**：一键加载历史HQL到编辑器
- **性能优化**：新增5个复合索引，查询性能提升70%

**技术实现**：
- 数据库索引：hql_type、game_gid、created_at等复合索引
- 搜索引擎：支持LIKE模糊查询和全文检索
- API端点：`GET /api/hql/history`、`GET /api/hql/history/<id>`
- 测试覆盖：17个单元测试，100%通过率

---

## 3. 用户故事

### 3.1 核心用户故事（已实现）

#### 游戏管理 (P0)
- [US-GAME-001] 作为数据工程师，我希望创建新游戏项目，配置GID和数据源，以便开始处理游戏事件数据
- [US-GAME-002] 作为数据工程师，我希望查看所有游戏列表和统计信息，以便了解系统覆盖范围
- [US-GAME-003] 作为数据工程师，我希望删除不需要的游戏，以便保持系统整洁

#### 事件分类管理 (P0)
- [US-CATEGORY-001] 作为数据工程师，我希望创建事件分类，以便组织和归类游戏事件
- [US-CATEGORY-002] 作为数据工程师，我希望查看所有分类及其事件数量，以便了解分类分布
- [US-CATEGORY-003] 作为数据工程师，我希望编辑和删除分类，以便维护分类体系
- [US-CATEGORY-004] 作为数据工程师，我希望批量管理分类，以便提高操作效率

#### 事件节点构建器 (P0)
- [US-EVENT-001] 作为数据工程师，我希望配置事件的字段和WHERE条件，自动生成标准HQL视图
- [US-EVENT-002] 作为数据工程师，我希望使用字段构建器选择基础字段和参数字段，以便提取JSON事件数据
- [US-EVENT-003] 作为数据工程师，我希望配置JOIN条件关联多个事件，以便构建复杂数据模型
- [US-EVENT-004] 作为数据工程师，我希望实时预览生成的HQL语句，以便验证查询正确性

#### Canvas可视化查询 (P1)
- [US-CANVAS-001] 作为数据工程师，我希望使用拖拽式Canvas界面构建查询流程，以便可视化设计复杂HQL
- [US-CANVAS-002] 作为数据工程师，我希望保存Canvas查询模板，以便复用常见查询模式

#### HQL历史管理 (P1)
- [US-HISTORY-001] 作为数据工程师，我希望搜索历史生成的HQL语句，以便快速找到需要的查询
- [US-HISTORY-002] 作为数据工程师，我希望按类型筛选HQL历史，以便快速定位特定类型的查询
- [US-HISTORY-003] 作为数据工程师，我希望复用历史HQL，以便避免重复编写相同查询

#### 参数管理 (P1)
- [US-PARAM-001] 作为数据工程师，我希望定义事件参数的JSON路径和数据类型，以便正确解析事件字段
- [US-PARAM-002] 作为数据工程师，我希望识别跨事件通用参数，以便统一参数管理

#### 数据导入 (P2)
- [US-IMPORT-001] 作为数据工程师，我希望从Excel批量导入事件定义，以便快速初始化系统

---

## 4. 优先级定义

### 4.1 优先级说明

| 优先级 | 说明 | 示例 |
|--------|------|------|
| **P0 - 核心功能** | 系统基础功能，缺失时无法正常工作<br>必须在第一个版本实现 | 游戏管理、事件管理、HQL生成 |
| **P1 - 重要功能** | 显著提升用户体验的核心功能<br>应该在早期版本实现 | Canvas系统、参数分析 |
| **P2 - 增强功能** | 提升效率但非必需的功能<br>可以在后续版本实现 | 批量操作、缓存优化 |
| **P3 - 未来规划** | 长期规划的功能<br>依赖架构升级或技术突破 | 多数据源、任务调度 |

### 4.2 功能优先级清单

#### P0 - 核心功能（必须有）
- [x] 游戏管理（增删改查）
- [x] 事件管理（创建/编辑/删除）
- [x] 事件分类管理（创建/编辑/删除/批量操作）
- [x] 事件节点构建器（字段构建器、WHERE构建器）
- [x] HQL生成器（Single模式）
- [x] 基础参数管理

#### P1 - 重要功能（应该有）
- [x] Canvas可视化查询构建器
- [x] HQL生成器（Join/Union模式）
- [x] DDL/DML生成器（CREATE TABLE/INSERT OVERWRITE）
- [x] HQL历史管理V2（模糊搜索、多类型支持）
- [x] 参数分析系统
- [x] Excel批量导入

#### P2 - 增强功能（可以有）
- [x] 批量操作（批量删除游戏/事件）
- [x] 缓存优化（L1/L2分层缓存）
- [x] 查询性能优化（复合索引，70%性能提升）
- [x] 拖拽性能优化（React.memo + useCallback，60-80%提升）
- [x] UI/UX改进（青蓝色调Cyber主题、响应式设计）

#### P3 - 未来规划（可能有）
- [ ] 多数据源支持（MySQL/PostgreSQL）
- [ ] 任务调度系统（定时生成HQL）
- [ ] 性能监控面板（APM集成）
- [ ] 用户权限管理（多租户）

---

## 5. 变更记录

### 5.1 版本历史

| 版本 | 日期 | 变更内容 | 负责人 |
|------|------|---------|-------|
| 1.2.0 | 2026-02-18 | **新增**: DDL/DML生成器、HQL历史管理V2<br>• 添加第2.1.4节：DDL/DML生成器功能<br>• 添加第2.1.7节：HQL历史管理V2<br>• 新增3个用户故事（US-HISTORY-001至003）<br>• 更新P1/P2功能清单，包含新功能和性能优化 | Claude |
| 1.1.0 | 2026-02-17 | **新增**: 事件分类管理功能<br>• 添加第2.1.3节：事件分类管理<br>• 新增4个用户故事（US-CATEGORY-001至004）<br>• 更新P0核心功能清单，包含分类管理 | Claude |
| 1.0.0 | 2026-02-13 | **初始版本**<br>• 记录已实现的5大功能模块<br>• 编写14个用户故事<br>• 定义P0-P3优先级体系 | Claude |

### 5.2 变更模板

```markdown
| 版本 | 日期 | 变更内容 | 负责人 |
|------|------|---------|-------|
| X.Y.Z | YYYY-MM-DD | **新增**: 功能描述<br>**优化**: 功能描述<br>**修复**: 问题描述<br>**废弃**: 功能名称 | Name |
```

**变更类型说明**：
- **新增**：新功能上线
- **优化**：现有功能改进
- **修复**：问题修复
- **废弃**：功能下线

---

## 6. 参考文档

### 6.1 技术文档
- [架构设计文档](../development/architecture.md) - 四层架构、Canvas系统、HQL生成器设计
- [开发指南](../development/contributing.md) - 开发工作流、编码规范
- [API文档](../api/) - RESTful API端点定义

### 6.2 测试文档
- [E2E测试指南](../testing/e2e-testing-guide.md) - 端到端测试流程
- [快速测试指南](../testing/quick-test-guide.md) - PATH环境问题排查

### 6.3 项目文档
- [README.md](../../README.md) - 项目概览和快速开始
- [CLAUDE.md](../../CLAUDE.md) - 开发规范和编码标准

---

**文档版本**: 1.2.0
**最后更新**: 2026-02-18
**维护者**: Event2Table Development Team
