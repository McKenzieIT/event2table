/**
 * TextButton E2E Tests
 *
 * 测试TextButton组件在FieldCanvas中的实际表现
 * 运行方式: npx playwright test textbutton-fieldcanvas.spec.ts
 */

import { test, expect } from '@playwright/test';

test.describe('TextButton in FieldCanvas', () => {
  test.beforeEach(async ({ page }) => {
    // 导航到EventNodeBuilder页面
    await page.goto('/event-node-builder');
    await page.waitForLoadState('networkidle');
  });

  test('should display edit and delete buttons with text only', async ({ page }) => {
    // 等待FieldCanvas加载
    await page.waitForSelector('.field-canvas');

    // 检查编辑按钮
    const editButton = page.locator('.field-actions .btn-edit').first();
    await expect(editButton).toBeVisible();
    await expect(editButton).toHaveText('编辑');

    // 检查删除按钮
    const deleteButton = page.locator('.field-actions .btn-delete').first();
    await expect(deleteButton).toBeVisible();
    await expect(deleteButton).toHaveText('删除');

    // 验证按钮没有图标（无i标签）
    const iconsInEdit = await editButton.locator('i').count();
    const iconsInDelete = await deleteButton.locator('i').count();
    expect(iconsInEdit).toBe(0);
    expect(iconsInDelete).toBe(0);
  });

  test('should have distinct colors for edit and delete buttons', async ({ page }) => {
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();
    const deleteButton = page.locator('.field-actions .btn-delete').first();

    // 获取按钮的计算样式
    const editColor = await editButton.evaluate((el) => {
      const styles = window.getComputedStyle(el);
      return {
        color: styles.color,
        borderColor: styles.borderColor
      };
    });

    const deleteColor = await deleteButton.evaluate((el) => {
      const styles = window.getComputedStyle(el);
      return {
        color: styles.color,
        borderColor: styles.borderColor
      };
    });

    // 验证编辑按钮为蓝色
    expect(editColor.color).toContain('13'); // RGB中的R值
    expect(editColor.borderColor).toContain('13');

    // 验证删除按钮为红色
    expect(deleteColor.color).toContain('220'); // RGB中的R值
    expect(deleteColor.borderColor).toContain('220');

    // 验证两个按钮颜色不同
    expect(editColor.color).not.toBe(deleteColor.color);
  });

  test('should have responsive button sizes', async ({ page }) => {
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();

    // 获取按钮尺寸
    const box = await editButton.boundingBox();
    expect(box).toBeTruthy();

    // 验证宽度在合理范围内（60-140px）
    if (box) {
      expect(box.width).toBeGreaterThanOrEqual(60);
      expect(box.width).toBeLessThanOrEqual(140);
    }
  });

  test('should show tooltip on hover', async ({ page }) => {
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();

    // 检查tooltip属性
    const tooltip = await editButton.getAttribute('title');
    expect(tooltip).toBeTruthy();
    expect(tooltip).toContain('编辑');

    // 悬停并验证
    await editButton.hover();
    await page.waitForTimeout(500);

    // 验证tooltip是否显示（浏览器原生tooltip）
    const titleAfterHover = await editButton.getAttribute('title');
    expect(titleAfterHover).toBe(tooltip);
  });

  test('should be clickable and trigger actions', async ({ page }) => {
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();

    // 点击编辑按钮
    await editButton.click();

    // 验证是否打开了编辑模态框（假设有modal显示）
    // 这里根据实际实现调整
    const modal = page.locator('.modal-content, [role="dialog"]').first();
    await expect(modal).toBeVisible({ timeout: 3000 });
  });

  test('should have proper hover effects', async ({ page }) => {
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();

    // 获取hover前的背景色
    const bgBefore = await editButton.evaluate((el) => {
      return window.getComputedStyle(el).backgroundColor;
    });

    // 悬停
    await editButton.hover();
    await page.waitForTimeout(300);

    // 获取hover后的背景色
    const bgAfter = await editButton.evaluate((el) => {
      return window.getComputedStyle(el).backgroundColor;
    });

    // 验证背景色有变化
    expect(bgBefore).not.toBe(bgAfter);
  });

  test('should be accessible via keyboard', async ({ page }) => {
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();

    // 使用Tab键聚焦按钮
    await page.keyboard.press('Tab');
    await page.waitForTimeout(200);

    // 验证按钮被聚焦
    const isFocused = await editButton.evaluate((el) => document.activeElement === el);
    expect(isFocused).toBeTruthy();

    // 使用Enter键触发
    await page.keyboard.press('Enter');

    // 验证动作被触发
    const modal = page.locator('.modal-content, [role="dialog"]').first();
    await expect(modal).toBeVisible({ timeout: 3000 });
  });

  test('should display correctly on mobile viewport', async ({ page }) => {
    // 设置移动端视口
    await page.setViewportSize({ width: 375, height: 667 });
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();
    const deleteButton = page.locator('.field-actions .btn-delete').first();

    // 验证按钮可见
    await expect(editButton).toBeVisible();
    await expect(deleteButton).toBeVisible();

    // 验证按钮宽度在移动端适当缩小
    const editBox = await editButton.boundingBox();
    const deleteBox = await deleteButton.boundingBox();

    if (editBox && deleteBox) {
      // 移动端按钮应该更小
      expect(editBox.width).toBeLessThanOrEqual(100);
      expect(deleteBox.width).toBeLessThanOrEqual(100);
    }

    // 验证按钮不溢出屏幕
    const fieldActions = page.locator('.field-actions').first();
    const actionsBox = await fieldActions.boundingBox();

    if (actionsBox) {
      expect(actionsBox.width).toBeLessThanOrEqual(375); // 不超过屏幕宽度
    }
  });
});

test.describe('TextButton Visual Regression', () => {
  test('should match screenshot for edit button', async ({ page }) => {
    await page.goto('/event-node-builder');
    await page.waitForSelector('.field-canvas');

    const editButton = page.locator('.field-actions .btn-edit').first();

    // 截图对比
    await expect(editButton).toHaveScreenshot('edit-button.png', {
      maxDiffPixels: 10
    });
  });

  test('should match screenshot for delete button', async ({ page }) => {
    await page.goto('/event-node-builder');
    await page.waitForSelector('.field-canvas');

    const deleteButton = page.locator('.field-actions .btn-delete').first();

    // 截图对比
    await expect(deleteButton).toHaveScreenshot('delete-button.png', {
      maxDiffPixels: 10
    });
  });
});
