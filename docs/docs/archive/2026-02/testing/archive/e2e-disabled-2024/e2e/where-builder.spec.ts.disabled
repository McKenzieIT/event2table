import { test, expect } from '@playwright/test';

test.describe('WHERE条件构建器 - E2E测试', () => {
  test.beforeEach(async ({ page }) => {
    // 设置游戏数据（模拟真实用户流程）
    await page.goto('/react-app-shell/#/');
    await page.evaluate(() => {
      localStorage.setItem('selectedGameGid', '10000147');
      window.gameData = {
        id: 16,
        gid: '10000147',
        name: '游戏 10000147',
        ods_db: 'ieu_ods',
      };
      window.gamesList = [{
        id: 16,
        gid: '10000147',
        name: '游戏 10000147',
        ods_db: 'ieu_ods',
      }];
    });

    // 访问事件节点构建器页面
    await page.goto('/react-app-shell/#/event-node-builder?game_gid=10000147');
    await page.waitForLoadState('networkidle');

    // 额外等待React应用初始化
    await page.waitForTimeout(3000);
  });

  test('应该能够打开WHERE构建器模态框', async ({ page }) => {
    // 等待页面加载完成
    await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });

    // 点击配置按钮
    await page.click('[data-testid="open-where-builder"]');

    // 验证模态框打开
    const modal = page.locator('.where-builder-modal').first();
    await expect(modal).toBeVisible();

    // 验证标题
    await expect(modal.locator('h3')).toContainText('WHERE条件构建器');
  });

  test('应该能够添加简单WHERE条件', async ({ page }) => {
    // 等待页面加载
    await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });

    // 打开WHERE构建器
    await page.click('[data-testid="open-where-builder"]');

    // 点击"添加条件"按钮
    await page.click('.where-toolbar button:has-text("添加条件")');

    // 选择字段
    await page.selectOption('.field-selector', 'ds');

    // 选择操作符
    await page.selectOption('.operator-selector', '=');

    // 输入值
    await page.fill('.value-input', '20240101');

    // 验证预览更新
    const preview = page.locator('.where-preview-code');
    await expect(preview).toContainText("ds = '20240101'");
  });

  test('应该能够应用WHERE条件到画布', async ({ page }) => {
    // 等待页面加载
    await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });

    // 打开WHERE构建器
    await page.click('[data-testid="open-where-builder"]');

    // 添加条件
    await page.click('.where-toolbar button:has-text("添加条件")');
    await page.selectOption('.field-selector', 'ds');
    await page.selectOption('.operator-selector', '=');
    await page.fill('.value-input', '20240101');

    // 点击"应用"按钮
    await page.click('.where-builder-modal .btn-primary:has-text("应用")');

    // 验证模态框关闭（表示应用成功）
    const modal = page.locator('.where-builder-modal');
    await expect(modal).not.toBeVisible();
  });

  test('应该能够添加多个条件并支持拖拽排序', async ({ page }) => {
    // 等待页面加载
    await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });

    // 打开WHERE构建器
    await page.click('[data-testid="open-where-builder"]');

    // 添加第一个条件
    await page.click('.where-toolbar button:has-text("添加条件")');
    await page.selectOption('.field-selector >> nth=0', 'ds');
    await page.selectOption('.operator-selector >> nth=0', '=');
    await page.fill('.value-input >> nth=0', '20240101');

    // 添加第二个条件
    await page.click('.where-toolbar button:has-text("添加条件")');
    await page.selectOption('.field-selector >> nth=1', 'role_id');
    await page.selectOption('.operator-selector >> nth=1', '>');
    await page.fill('.value-input >> nth=1', '100');

    // 验证预览包含两个条件
    const preview = page.locator('.where-preview-code');
    await expect(preview).toContainText('ds');
    await expect(preview).toContainText('role_id');
  });

  test('应该能够切换简单/高级模式', async ({ page }) => {
    // 等待页面加载
    await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });

    // 打开WHERE构建器
    await page.click('[data-testid="open-where-builder"]');

    // 验证默认简单模式
    await expect(page.locator('.mode-toggle .btn-primary')).toContainText('简单模式');

    // 切换到高级模式
    await page.click('.mode-toggle button:has-text("高级模式")');

    // 验证高级模式按钮
    await expect(page.locator('.mode-toggle .btn-primary')).toContainText('高级模式');

    // 验证"添加分组"按钮可见
    await expect(page.locator('.where-toolbar button:has-text("添加分组")')).toBeVisible();
  });
});

test.describe('WHERE条件构建器 - 验证测试', () => {
  test.beforeEach(async ({ page }) => {
    // 设置游戏数据
    await page.goto('/react-app-shell/#/');
    await page.evaluate(() => {
      localStorage.setItem('selectedGameGid', '10000147');
      window.gameData = {
        id: 16,
        gid: '10000147',
        name: '游戏 10000147',
        ods_db: 'ieu_ods',
      };
    });

    await page.goto('/react-app-shell/#/event-node-builder?game_gid=10000147');
    await page.waitForLoadState('networkidle');
    await page.waitForTimeout(3000);
  });

  test('应该验证缺失字段的条件', async ({ page }) => {
    // 等待页面加载
    await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });

    // 打开WHERE构建器
    await page.click('[data-testid="open-where-builder"]');

    // 添加条件但不填写字段
    await page.click('.where-toolbar button:has-text("添加条件")');

    // 尝试应用（应该显示验证错误）
    page.on('dialog', dialog => dialog.accept());

    await page.click('.where-builder-modal .btn-primary:has-text("应用")');

    // 验证错误提示（Playwright会自动处理alert）
  });
});
