import { test, expect } from '@playwright/test';
import { navigateToPage, PAGE_PATHS } from '../helpers/url-helper';

test('TDZ Error Diagnostic', async ({ page }) => {
  const allErrors: any[] = [];

  // Capture console errors
  page.on('console', msg => {
    if (msg.type() === 'error') {
      allErrors.push({
        type: 'console',
        text: msg.text(),
        location: msg.location()
      });
    }
  });

  // Capture page errors
  page.on('pageerror', error => {
    allErrors.push({
      type: 'page',
      message: error.message,
      stack: error.stack
    });
  });

  // Capture request failures
  page.on('requestfailed', request => {
    allErrors.push({
      type: 'request',
      url: request.url(),
      failure: request.failure()
    });
  });

  console.log('Navigating to canvas...');
  await navigateToPage(page, PAGE_PATHS.CANVAS, { gameGid: '10000147' });

  // Wait for page to load
  try {
    await page.waitForSelector('#app-root', { state: 'visible', timeout: 10000 });
    console.log('✓ app-root is visible');
  } catch (e) {
    console.log('✗ app-root not found');
  }

  // Wait a bit for lazy loading
  await page.waitForTimeout(5000);

  // Check if React mounted
  const reactCheck = await page.evaluate(() => {
    const appRoot = document.getElementById('app-root');
    return {
      hasChildren: appRoot ? appRoot.children.length > 0 : false,
      innerHTMLLength: appRoot ? appRoot.innerHTML.length : 0,
      hasReactContent: appRoot ? appRoot.innerHTML.includes('canvas') : false
    };
  });

  console.log('\n=== React Mount Status ===');
  console.log('Has children:', reactCheck.hasChildren);
  console.log('innerHTML length:', reactCheck.innerHTMLLength);
  console.log('Has React content:', reactCheck.hasReactContent);

  // Filter TDZ errors
  const tdzErrors = allErrors.filter(e =>
    e.message?.includes('Cannot access') ||
    e.message?.includes('before initialization') ||
    e.message?.includes('ReferenceError') ||
    e.text?.includes('Cannot access') ||
    e.text?.includes('before initialization') ||
    e.text?.includes('ReferenceError')
  );

  console.log('\n=== TDZ/Reference Errors Found:', tdzErrors.length, '===');
  tdzErrors.forEach((err, i) => {
    console.log(`\n[Error ${i + 1}]`);
    console.log('Type:', err.type);
    console.log('Message:', err.message || err.text);
    if (err.stack) {
      console.log('Stack:', err.stack);
    }
    if (err.location) {
      console.log('Location:', err.location);
    }
  });

  console.log('\n=== All Errors Summary ===');
  console.log('Total errors:', allErrors.length);
  console.log('Console errors:', allErrors.filter(e => e.type === 'console').length);
  console.log('Page errors:', allErrors.filter(e => e.type === 'page').length);
  console.log('Request failures:', allErrors.filter(e => e.type === 'request').length);

  // Test will pass but we're gathering diagnostic info
  expect(reactCheck.hasChildren).toBe(true);
});
