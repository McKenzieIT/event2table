import { test, expect } from '@playwright/test';

test('WHERE Builder - Debug with screenshots', async ({ page }) => {
  // 设置游戏数据
  await page.goto('/react-app-shell/#/');
  await page.evaluate(() => {
    localStorage.setItem('selectedGameGid', '10000147');
    (window as any).gameData = {
      id: 16,
      gid: '10000147',
      name: '游戏 10000147',
      ods_db: 'ieu_ods',
    };
  });

  // 访问事件节点构建器页面
  await page.goto('/react-app-shell/#/event-node-builder?game_gid=10000147');
  await page.waitForLoadState('networkidle');
  await page.waitForTimeout(3000);

  console.log('\n=== Screenshot 1: Initial page ===');
  await page.screenshot({ path: 'debug-1-initial.png', fullPage: true });

  // 等待主组件加载
  await expect(page.locator('.event-node-builder')).toBeVisible({ timeout: 10000 });
  console.log('✓ EventNodeBuilder is visible');

  // 检查配置按钮是否存在
  const configButton = page.locator('[data-testid="open-where-builder"]');
  await expect(configButton).toBeVisible({ timeout: 5000 });
  console.log('✓ Config button is visible');

  // 点击配置按钮
  console.log('\n=== Clicking config button ===');
  await configButton.click();
  await page.waitForTimeout(2000);

  console.log('\n=== Screenshot 2: After clicking config ===');
  await page.screenshot({ path: 'debug-2-after-config.png', fullPage: true });

  // 检查模态框是否打开
  const modal = page.locator('.where-builder-modal');
  const modalCount = await modal.count();
  console.log('Modal count:', modalCount);

  if (modalCount > 0) {
    console.log('✓ Modal is present');
    const isVisible = await modal.isVisible();
    console.log('Modal visible:', isVisible);

    // 获取模态框内容
    const modalContent = await modal.innerHTML();
    console.log('Modal content length:', modalContent.length);

    // 检查添加条件按钮
    const addButton = page.locator('.where-toolbar button:has-text("添加条件")');
    const addCount = await addButton.count();
    console.log('Add button count:', addCount);

    if (addCount > 0) {
      console.log('✓ Add button found');
      console.log('\n=== Screenshot 3: Before clicking add ===');
      await page.screenshot({ path: 'debug-3-before-add.png' });

      // 点击添加条件
      await addButton.click();
      await page.waitForTimeout(2000);

      console.log('\n=== Screenshot 4: After clicking add ===');
      await page.screenshot({ path: 'debug-4-after-add.png', fullPage: true });

      // 检查条件项
      const conditionItem = page.locator('.where-condition-item');
      const conditionCount = await conditionItem.count();
      console.log('Condition count:', conditionCount);

      // 检查字段选择器
      const fieldSelector = page.locator('.field-selector');
      const fieldCount = await fieldSelector.count();
      console.log('Field selector count:', fieldCount);

      if (fieldCount > 0) {
        console.log('✓ Field selector found!');
        await fieldSelector.first().selectOption('ds');
        console.log('✓ Selected ds');
      } else {
        console.log('❌ Field selector not found');
        console.log('Looking for alternatives...');
        const allSelects = await page.locator('select').count();
        console.log('Total select elements:', allSelects);
      }
    } else {
      console.log('❌ Add button not found');
      console.log('Available buttons:', await page.locator('.where-toolbar button').allTextContents());
    }
  } else {
    console.log('❌ Modal not found');
    console.log('Available modals:', await page.locator('[class*="modal"]').count());
  }

  console.log('\n=== Final screenshot ===');
  await page.screenshot({ path: 'debug-5-final.png', fullPage: true });
});
