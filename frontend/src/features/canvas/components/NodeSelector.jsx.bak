import React, { useState, useEffect, useCallback } from "react";
import { SearchInput } from '@shared/ui/SearchInput';
import "./NodeSelector.css";

/**
 * èŠ‚ç‚¹é€‰æ‹©å™¨ç»„ä»¶
 * ç”¨äºåœ¨è¿æ¥æç¤ºæ¨¡æ€æ¡†ä¸­é€‰æ‹©ç›®æ ‡èŠ‚ç‚¹
 *
 * @param {Array} nodes - å¯é€‰èŠ‚ç‚¹åˆ—è¡¨
 * @param {Function} onSelect - èŠ‚ç‚¹é€‰æ‹©å›è°ƒ
 * @param {string} selectedId - å·²é€‰æ‹©çš„èŠ‚ç‚¹ID
 * @param {string} filterType - è¿‡æ»¤çš„èŠ‚ç‚¹ç±»å‹
 *
 * @example
 * <NodeSelector
 *   nodes={nodes}
 *   onSelect={handleNodeSelect}
 *   selectedId={selectedNodeId}
 *   filterType="output"
 * />
 */
export default function NodeSelector({
  nodes,
  onSelect,
  selectedId,
  filterType,
}) {
  const [searchTerm, setSearchTerm] = useState("");
  const [filteredNodes, setFilteredNodes] = useState([]);

  // è¿‡æ»¤èŠ‚ç‚¹
  useEffect(() => {
    let filtered = nodes;

    // æŒ‰ç±»å‹è¿‡æ»¤
    if (filterType) {
      filtered = filtered.filter((node) => node.type === filterType);
    }

    // æŒ‰æœç´¢è¯è¿‡æ»¤
    if (searchTerm) {
      const term = searchTerm.toLowerCase();
      filtered = filtered.filter(
        (node) =>
          node.data.label.toLowerCase().includes(term) ||
          (node.data.eventName &&
            node.data.eventName.toLowerCase().includes(term)),
      );
    }

    setFilteredNodes(filtered);
  }, [nodes, searchTerm, filterType]);

  // ç”ŸæˆèŠ‚ç‚¹ç±»å‹çš„å›¾æ ‡
  const getNodeIcon = (nodeType) => {
    const icons = {
      event: "ğŸ®",
      union_all: "ğŸ”€",
      join: "ğŸ”—",
      output: "ğŸ“¤",
    };
    return icons[nodeType] || "ğŸ“¦";
  };

  // ç”ŸæˆèŠ‚ç‚¹ç±»å‹çš„ä¸­æ–‡åç§°
  const getNodeTypeName = (nodeType) => {
    const names = {
      event: "äº‹ä»¶èŠ‚ç‚¹",
      union_all: "UNION ALL",
      join: "JOIN",
      output: "è¾“å‡ºèŠ‚ç‚¹",
    };
    return names[nodeType] || "æœªçŸ¥ç±»å‹";
  };

  // å¤„ç†èŠ‚ç‚¹é€‰æ‹©
  const handleNodeSelect = useCallback(
    (node) => {
      if (onSelect) {
        onSelect(node);
      }
    },
    [onSelect],
  );

  // æ¸…é™¤æœç´¢
  const handleClearSearch = useCallback(() => {
    setSearchTerm("");
  }, []);

  return (
    <div className="node-selector">
      <SearchInput
        placeholder="æœç´¢èŠ‚ç‚¹åç§°..."
        value={searchTerm}
        onChange={(value) => setSearchTerm(value)}
        onClear={handleClearSearch}
      />
    </div>
            title="æ¸…é™¤æœç´¢"
          >
            Ã—
          </button>
        )}
      </div>

      <div className="node-list">
        {filteredNodes.length === 0 ? (
          <div className="empty-state">
            {searchTerm ? "æ²¡æœ‰æ‰¾åˆ°åŒ¹é…çš„èŠ‚ç‚¹" : "æ²¡æœ‰å¯é€‰æ‹©çš„èŠ‚ç‚¹"}
          </div>
        ) : (
          filteredNodes.map((node) => (
            <div
              key={node.id}
              className={`node-item ${selectedId === node.id ? "selected" : ""}`}
              onClick={() => handleNodeSelect(node)}
            >
              <div className="node-content">
                <span className="node-icon">{getNodeIcon(node.type)}</span>
                <div className="node-info">
                  <span className="node-label">{node.data.label}</span>
                  {node.data.eventName && (
                    <span className="node-sublabel">{node.data.eventName}</span>
                  )}
                </div>
              </div>
              <div className="node-type">{getNodeTypeName(node.type)}</div>
              {selectedId === node.id && <span className="checkmark">âœ“</span>}
            </div>
          ))
        )}
      </div>

      {filteredNodes.length > 0 && (
        <div className="node-count">å…± {filteredNodes.length} ä¸ªèŠ‚ç‚¹</div>
      )}
    </div>
  );
}
