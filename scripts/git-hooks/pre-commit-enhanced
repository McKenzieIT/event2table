#!/bin/bash
# Git Pre-commit Hook - Enhanced Version
#
# æ£€æŸ¥é¡¹ç›®ä»£ç è´¨é‡ï¼š
# 1. æ•°æ®åº“æ–‡ä»¶ä½ç½®æ£€æŸ¥
# 2. ESLintæ£€æŸ¥
# 3. TypeScriptç±»å‹æ£€æŸ¥
#
# ä½¿ç”¨æ–¹æ³•ï¼š
# 1. å®‰è£…ï¼šcp scripts/git-hooks/pre-commit-enhanced .git/hooks/pre-commit
# 2. èµ‹äºˆæƒé™ï¼šchmod +x .git/hooks/pre-commit

set -e

# é¢œè‰²å®šä¹‰
RED='\033[91m'
GREEN='\033[92m'
YELLOW='\033[93m'
RESET='\033[0m'
BOLD='\033[1m'

echo -e "${YELLOW}ğŸ” Running pre-commit checks...${RESET}"

# è·å–é¡¹ç›®æ ¹ç›®å½•
PROJECT_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/../.." && pwd)"
cd "$PROJECT_ROOT"

# ============================================================================
# Check 1: æ•°æ®åº“æ–‡ä»¶ä½ç½®æ£€æŸ¥
# ============================================================================
echo -e "\n${YELLOW}ğŸ“‚ Check 1/3: Database file location...${RESET}"

python3 scripts/git-hooks/pre-commit
if [ $? -ne 0 ]; then
    echo -e "${RED}âŒ Database file location check failed!${RESET}\n"
    exit 1
fi

echo -e "${GREEN}âœ… Database file location check passed!${RESET}"

# ============================================================================
# Check 2: ESLint æ£€æŸ¥
# ============================================================================
echo -e "\n${YELLOW}ğŸ“‹ Check 2/3: ESLint code quality...${RESET}"

# æ£€æŸ¥æ˜¯å¦æœ‰æš‚å­˜çš„æ–‡ä»¶
STAGED_FILES=$(git diff --cached --name-only --diff-filter=ACM | grep -E '\.(js|jsx|ts|tsx)$' || true)

if [ -z "$STAGED_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  No JavaScript/TypeScript files staged, skipping ESLint${RESET}"
else
    echo -e "${YELLOW}Running ESLint on staged files...${RESET}"

    # è¿è¡ŒESLintä»…å¯¹æš‚å­˜çš„æ–‡ä»¶
    cd frontend
    echo "$STAGED_FILES" | while read -r file; do
        if [ -f "$file" ]; then
            echo "  Checking: $file"
            npx eslint "$file" --max-warnings=10
            if [ $? -ne 0 ]; then
                echo -e "${RED}âŒ ESLint check failed for: $file${RESET}"
                echo -e "${YELLOW}ğŸ’¡ Run 'npm run lint' to see all errors${RESET}"
                exit 1
            fi
        fi
    done
    cd ..

    echo -e "${GREEN}âœ… ESLint check passed!${RESET}"
fi

# ============================================================================
# Check 3: TypeScript ç±»å‹æ£€æŸ¥ï¼ˆä»…å¯¹TypeScriptæ–‡ä»¶ï¼‰
# ============================================================================
echo -e "\n${YELLOW}ğŸ”§ Check 3/3: TypeScript type checking...${RESET}"

TS_FILES=$(echo "$STAGED_FILES" | grep -E '\.(ts|tsx)$' || true)

if [ -z "$TS_FILES" ]; then
    echo -e "${YELLOW}âš ï¸  No TypeScript files staged, skipping type check${RESET}"
else
    echo -e "${YELLOW}Running TypeScript type check...${RESET}"

    cd frontend
    npx tsc --noEmit --pretty
    if [ $? -ne 0 ]; then
        echo -e "${RED}âŒ TypeScript type check failed!${RESET}"
        echo -e "${YELLOW}ğŸ’¡ Run 'npm run type-check' to see all errors${RESET}"
        exit 1
    fi
    cd ..

    echo -e "${GREEN}âœ… TypeScript type check passed!${RESET}"
fi

# ============================================================================
# All checks passed
# ============================================================================
echo -e "\n${GREEN}${BOLD}âœ… All pre-commit checks passed!${RESET}"
echo -e "${GREEN}âœ… Proceeding with commit...${RESET}\n"

exit 0
