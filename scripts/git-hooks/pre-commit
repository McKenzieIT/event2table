#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
Git Pre-commit Hook - Database File Location Check

æ£€æŸ¥æ˜¯å¦åœ¨é”™è¯¯ä½ç½®åˆ›å»ºäº†æ•°æ®åº“æ–‡ä»¶ï¼ˆ*.db, *.db-shm, *.db-walï¼‰

è¿è¡Œæ—¶æœºï¼šæ¯æ¬¡ git commit å‰
é˜»æ­¢æ¡ä»¶ï¼šå‘ç° data/ ç›®å½•ä¹‹å¤–çš„æ•°æ®åº“æ–‡ä»¶

ä½¿ç”¨æ–¹æ³•ï¼š
1. è‡ªåŠ¨å®‰è£…ï¼špython scripts/git-hooks/install_hooks.py
2. æ‰‹åŠ¨å®‰è£…ï¼šcp scripts/git-hooks/pre-commit .git/hooks/pre-commit
3. èµ‹äºˆæ‰§è¡Œæƒé™ï¼šchmod +x .git/hooks/pre-commit
"""

import os
import sys
from pathlib import Path

# ANSI color codes
RED = '\033[91m'
GREEN = '\033[92m'
YELLOW = '\033[93m'
RESET = '\033[0m'
BOLD = '\033[1m'

def find_misplaced_database_files():
    """
    æŸ¥æ‰¾é”™è¯¯æ”¾ç½®çš„æ•°æ®åº“æ–‡ä»¶

    Returns:
        list: é”™è¯¯æ”¾ç½®çš„æ•°æ®åº“æ–‡ä»¶è·¯å¾„åˆ—è¡¨
    """
    # è·å–é¡¹ç›®æ ¹ç›®å½•ï¼ˆ.gitæ‰€åœ¨ä½ç½®çš„çˆ¶ç›®å½•ï¼‰
    git_dir = Path(__file__).parent.parent.parent / '.git'
    if not git_dir.exists():
        # fallback: ä½¿ç”¨å½“å‰è„šæœ¬ä½ç½®å‘ä¸ŠæŸ¥æ‰¾
        root_dir = Path(__file__).parent.parent.parent
    else:
        root_dir = git_dir.parent

    # å…è®¸çš„æ•°æ®åº“æ–‡ä»¶ç›®å½•
    allowed_dirs = {
        root_dir / 'data',
        root_dir / '.git',
    }

    # æŸ¥æ‰¾æ‰€æœ‰æ•°æ®åº“æ–‡ä»¶
    misplaced_files = []

    for ext in ['*.db', '*.db-shm', '*.db-wal']:
        # ä½¿ç”¨ rglob è¿›è¡Œé€’å½’æœç´¢
        for db_file in root_dir.rglob(ext):
            # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦åœ¨å…è®¸çš„ç›®å½•ä¸­
            in_allowed_dir = any(
                db_file.is_relative_to(allowed_dir)
                for allowed_dir in allowed_dirs
            )

            # æ£€æŸ¥æ˜¯å¦åœ¨è™šæ‹Ÿç¯å¢ƒä¸­ï¼ˆvenv/ï¼‰
            in_venv = 'venv' in db_file.parts or 'venv' in str(db_file)

            # æ£€æŸ¥æ˜¯å¦åœ¨node_modulesä¸­
            in_node_modules = 'node_modules' in db_file.parts

            # æ£€æŸ¥æ˜¯å¦åœ¨git worktreesä¸­
            in_worktrees = '.worktrees' in db_file.parts

            if not in_allowed_dir and not in_venv and not in_node_modules and not in_worktrees:
                misplaced_files.append(db_file)

    return misplaced_files

def main():
    """ä¸»å‡½æ•°"""
    print(f"{YELLOW}ğŸ” Running pre-commit hook: Database file location check...{RESET}")

    # æŸ¥æ‰¾é”™è¯¯æ”¾ç½®çš„æ•°æ®åº“æ–‡ä»¶
    misplaced_files = find_misplaced_database_files()

    if misplaced_files:
        # å‘ç°é”™è¯¯æ”¾ç½®çš„æ–‡ä»¶ï¼Œé˜»æ­¢æäº¤
        print(f"\n{RED}{BOLD}âŒ Database files found outside data/ directory!{RESET}\n")
        print(f"{RED}{BOLD}ERROR: Found {len(misplaced_files)} database file(s) in incorrect locations:{RESET}\n")

        for file in misplaced_files:
            rel_path = file.relative_to(Path(__file__).parent.parent.parent)
            size = file.stat().st_size if file.exists() else 0
            print(f"  {RED}âœ—{RESET} {rel_path} ({size} bytes)")

        print(f"\n{YELLOW}ğŸ“‹ How to fix:{RESET}")
        print(f"  1. Move database files to data/ directory:")
        print(f"     {GREEN}mv dwd_generator.db data/{RESET}")
        print(f"     {GREEN}mv backend/core/config/dwd_generator.db data/{RESET}")
        print(f"\n  2. Or delete if outdated/test files:")
        print(f"     {GREEN}rm <file-path>{RESET}")
        print(f"\n  3. For more information, see:")
        print(f"     {GREEN}CLAUDE.md - æ•°æ®åº“æ–‡ä»¶ä½ç½®è§„èŒƒ{RESET}")
        print(f"\n{YELLOW}âš ï¸  Commit blocked! Please fix before committing.{RESET}\n")

        sys.exit(1)
    else:
        # æ²¡æœ‰å‘ç°é”™è¯¯æ”¾ç½®çš„æ–‡ä»¶
        print(f"{GREEN}âœ… Database file location check passed!{RESET}")
        print(f"{GREEN}âœ… Pre-commit hook passed!{RESET}\n")
        sys.exit(0)

if __name__ == '__main__':
    try:
        main()
    except Exception as e:
        print(f"{RED}âŒ Pre-commit hook error: {e}{RESET}\n")
        import traceback
        traceback.print_exc()
        sys.exit(1)
